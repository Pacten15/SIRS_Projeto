{% extends 'base.html' %}

{% block title %}Index{% endblock %}

{% block content %}

<table>

<tr>
	<th>Server's Public RSA Key</th>
	<th>Your Private/Public RSA Key</th>
</tr>
<tr>
	<td><textarea rows="9" cols="60" readonly id="server_public_key">{{ public_rsa }}</textarea></td>
	<td>
		<textarea rows="9" cols="60" id="user_private_key"></textarea>
	</td>
</tr>
<tr>
	<td>
		<button onclick="generateKeyPair();">Generate Keys</button>
	</td>
	<td>
		<textarea rows="9" cols="60" id="user_public_key"></textarea>
	</td>
</tr>
</table>


{% endblock %}

{% block script %}

let private_key_block = document.getElementById("user_private_key");
let public_key_block  = document.getElementById("user_public_key");

async function generateKeyPair() {
	const keyPair = await window.crypto.subtle.generateKey(
		{
			name: "RSA-OAEP",
			modulusLength: 2048,
			publicExponent: new Uint8Array([1, 0, 1]),
			hash: "SHA-256",
		},
		true,
		["encrypt", "decrypt"],
	);

	// First, show the public key
	const private_export = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey)
	let   private_as_b64 = window.btoa( String.fromCodePoint(...(new Uint8Array(private_export))) )

	// This splits the output, for aesthetics
	var accumulate = []
	while (private_as_b64.length > 64) {
		accumulate.push( private_as_b64.slice(0, 64) )
		private_as_b64 = private_as_b64.slice(64)
	}
	const privb64 = accumulate.join("\n") + ( private_as_b64.length ? "\n" + private_as_b64 : "")

	private_key_block.textContent = "-----BEGIN PRIVATE KEY-----\n"+privb64+"\n-----END PRIVATE KEY-----";

	// Then, show the public key
	const public_export = await window.crypto.subtle.exportKey("spki", keyPair.publicKey)
	let   public_as_b64 = window.btoa( String.fromCodePoint(...(new Uint8Array(public_export))) )

	// again, ~aesthetics~
	accumulate = []
	while (public_as_b64.length > 64) {
		accumulate.push( public_as_b64.slice(0, 64) )
		public_as_b64 = public_as_b64.slice(64)
	}
	const pubb64 = accumulate.join("\n") + ( public_as_b64.length ? "\n" + public_as_b64 : "")

	public_key_block.textContent = "-----BEGIN PUBLIC KEY-----\n"+pubb64+"\n-----END PUBLIC KEY-----";

}


{% endblock %}
